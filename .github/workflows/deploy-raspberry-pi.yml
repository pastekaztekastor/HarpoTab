# =============================================================================
# GitHub Actions Workflow - D√©ploiement automatique vers Raspberry Pi
# =============================================================================
#
# Ce workflow d√©ploie automatiquement HarpoTab sur un Raspberry Pi
# √† chaque push sur la branche main (apr√®s que les tests passent)
#
# Pr√©requis sur le Raspberry Pi :
# - Docker install√©
# - SSH activ√©
# - Cl√© SSH ajout√©e aux secrets GitHub
#
# =============================================================================

name: Deploy to Raspberry Pi

# =============================================================================
# D√âCLENCHEURS
# =============================================================================
on:
  # D√©ploiement automatique apr√®s push sur main
  push:
    branches: [ "main" ]
    # Ne d√©ployer que si des fichiers pertinents changent
    paths:
      - 'modules/**'
      - 'app.py'
      - 'config.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/deploy-raspberry-pi.yml'

  # Permet le d√©ploiement manuel
  workflow_dispatch:

# =============================================================================
# JOBS
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # JOB 1: Tests (doit passer avant d√©ploiement)
  # ---------------------------------------------------------------------------
  test:
    name: Tests unitaires
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Tests avec pytest
        run: |
          pytest tests/ -v --tb=short

  # ---------------------------------------------------------------------------
  # JOB 2: Build et push de l'image Docker
  # ---------------------------------------------------------------------------
  build:
    name: Build et push Docker image
    runs-on: ubuntu-latest
    needs: test  # Attend que les tests passent

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Option A: Docker Hub (public/private)
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Option B: GitHub Container Registry (recommand√©, gratuit)
      # D√©commente si tu pr√©f√®res GHCR au lieu de Docker Hub
      # - name: Login GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build et push de l'image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/harpotab:latest
            ${{ secrets.DOCKER_USERNAME }}/harpotab:${{ github.sha }}
          # Pour GHCR, utilise plut√¥t :
          # tags: |
          #   ghcr.io/${{ github.repository_owner }}/harpotab:latest
          #   ghcr.io/${{ github.repository_owner }}/harpotab:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # JOB 3: D√©ploiement sur Raspberry Pi
  # ---------------------------------------------------------------------------
  deploy:
    name: D√©ploiement sur Raspberry Pi
    runs-on: ubuntu-latest
    needs: build  # Attend que l'image soit build√©e

    steps:
      - name: D√©ploiement via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.RASPI_HOST }}
          username: ${{ secrets.RASPI_USER }}
          key: ${{ secrets.RASPI_SSH_KEY }}
          port: ${{ secrets.RASPI_PORT || 22 }}
          script: |
            echo "üöÄ D√©but du d√©ploiement HarpoTab..."

            # Aller dans le dossier de d√©ploiement
            cd ~/harpotab || mkdir -p ~/harpotab && cd ~/harpotab

            # Pull de la nouvelle image
            echo "üì¶ Pull de la nouvelle image Docker..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/harpotab:latest
            # Pour GHCR :
            # docker pull ghcr.io/${{ github.repository_owner }}/harpotab:latest

            # Arr√™ter et supprimer l'ancien conteneur (si existe)
            echo "üõë Arr√™t de l'ancien conteneur..."
            docker stop harpotab || true
            docker rm harpotab || true

            # Lancer le nouveau conteneur
            echo "üéØ Lancement du nouveau conteneur..."
            docker run -d \
              --name harpotab \
              --restart unless-stopped \
              -p 5000:5000 \
              -v ~/harpotab/data:/app/data \
              -v ~/harpotab/uploads:/app/static/uploads \
              -v ~/harpotab/outputs:/app/static/outputs \
              -e FLASK_ENV=production \
              ${{ secrets.DOCKER_USERNAME }}/harpotab:latest \
              python app.py
            # Pour GHCR :
            # ghcr.io/${{ github.repository_owner }}/harpotab:latest \

            # Nettoyer les anciennes images
            echo "üßπ Nettoyage des anciennes images..."
            docker image prune -f

            # V√©rifier que le conteneur tourne
            echo "‚úÖ V√©rification du d√©ploiement..."
            sleep 5
            if docker ps | grep harpotab; then
              echo "‚úÖ HarpoTab d√©ploy√© avec succ√®s !"
              docker logs harpotab --tail 20
            else
              echo "‚ùå Erreur lors du d√©ploiement"
              docker logs harpotab --tail 50
              exit 1
            fi

      - name: Notification de succ√®s
        if: success()
        run: |
          echo "‚úÖ D√©ploiement r√©ussi sur Raspberry Pi !"
          echo "üåê HarpoTab est accessible sur http://${{ secrets.RASPI_HOST }}:5000"

      - name: Notification d'√©chec
        if: failure()
        run: |
          echo "‚ùå √âchec du d√©ploiement"
          echo "üìã Consulte les logs ci-dessus pour plus de d√©tails"

# =============================================================================
# CONFIGURATION REQUISE
# =============================================================================
#
# Secrets GitHub √† configurer (Settings ‚Üí Secrets and variables ‚Üí Actions) :
#
# 1. DOCKER (choisir Option A ou B)
#    Option A - Docker Hub:
#      - DOCKER_USERNAME : Ton nom d'utilisateur Docker Hub
#      - DOCKER_PASSWORD : Token d'acc√®s Docker Hub
#
#    Option B - GitHub Container Registry (GHCR):
#      - Rien √† configurer, GITHUB_TOKEN est automatique
#
# 2. RASPBERRY PI (SSH):
#    - RASPI_HOST : IP ou hostname du Raspberry Pi (ex: 192.168.1.100)
#    - RASPI_USER : Nom d'utilisateur SSH (ex: pi)
#    - RASPI_SSH_KEY : Cl√© priv√©e SSH (contenu de ~/.ssh/id_rsa)
#    - RASPI_PORT : Port SSH (optionnel, d√©faut: 22)
#
# =============================================================================
