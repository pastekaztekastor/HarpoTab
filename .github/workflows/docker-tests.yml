# =============================================================================
# GitHub Actions Workflow - Tests d'intégration avec Docker + Audiveris
# =============================================================================
#
# Ce workflow complète tests.yml en ajoutant des tests d'intégration complets
# avec Audiveris OCR dans un environnement Docker isolé
#
# Différences avec tests.yml:
# - tests.yml: Tests unitaires rapides (~30s), pas d'Audiveris
# - docker-tests.yml: Tests d'intégration lents (~5-10min), avec Audiveris

name: Docker Integration Tests

# =============================================================================
# DÉCLENCHEURS
# =============================================================================
on:
  # Lancement manuel uniquement (évite de surcharger la CI)
  workflow_dispatch:

  # Optionnel: lancer sur push vers main uniquement
  push:
    branches: [ "main" ]
    # Ne lancer que si des fichiers pertinents changent
    paths:
      - 'modules/**'
      - 'tests/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/docker-tests.yml'

  # Optionnel: sur les pull requests vers main
  pull_request:
    branches: [ "main" ]
    paths:
      - 'modules/**'
      - 'tests/**'
      - 'Dockerfile'
      - 'requirements.txt'

# =============================================================================
# JOBS
# =============================================================================
jobs:
  docker-integration-tests:
    name: Tests d'intégration avec Audiveris
    runs-on: ubuntu-latest

    # ==========================================================================
    # ÉTAPES
    # ==========================================================================
    steps:
      # -----------------------------------------------------------------------
      # ÉTAPE 1: Checkout du code
      # -----------------------------------------------------------------------
      - name: Checkout du code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # ÉTAPE 2: Configuration Docker Buildx (pour cache efficace)
      # -----------------------------------------------------------------------
      - name: Configuration Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # ÉTAPE 3: Cache des layers Docker (accélère les builds)
      # -----------------------------------------------------------------------
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # -----------------------------------------------------------------------
      # ÉTAPE 4: Build de l'image Docker
      # -----------------------------------------------------------------------
      - name: Build de l'image Docker HarpoTab
        run: |
          docker build \
            --tag harpotab:latest \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            .

      # -----------------------------------------------------------------------
      # ÉTAPE 5: Vérifier que l'image fonctionne
      # -----------------------------------------------------------------------
      - name: Vérification de l'image Docker
        run: |
          echo "=== Vérification des outils installés ==="
          docker run --rm harpotab:latest python --version
          docker run --rm harpotab:latest java --version
          docker run --rm harpotab:latest lilypond --version
          docker run --rm harpotab:latest tesseract --version

          echo "=== Vérification d'Audiveris ==="
          docker run --rm harpotab:latest audiveris --help || echo "Audiveris nécessite X11 pour certaines commandes"

      # -----------------------------------------------------------------------
      # ÉTAPE 6: Tests unitaires dans Docker
      # -----------------------------------------------------------------------
      - name: Tests unitaires dans Docker
        run: |
          docker run --rm harpotab:latest pytest tests/ -v --tb=short --color=yes

      # -----------------------------------------------------------------------
      # ÉTAPE 7: Tests d'intégration Audiveris (si disponibles)
      # -----------------------------------------------------------------------
      # Note: Cette étape nécessite des fichiers de test réels (PDF/PNG)
      # et des tests d'intégration spécifiques dans tests/integration/
      - name: Tests d'intégration Audiveris
        run: |
          # Pour l'instant, on vérifie juste que les modules se chargent
          docker run --rm harpotab:latest python -c "
          from modules.ocr_reader import AudiverisOCR
          from modules.melody_extractor import MelodyExtractor
          from modules.transposer import Transposer
          print('✅ Tous les modules HarpoTab sont importables')
          "
        continue-on-error: true

      # -----------------------------------------------------------------------
      # ÉTAPE 8: Rapport de couverture dans Docker
      # -----------------------------------------------------------------------
      - name: Génération du rapport de couverture
        run: |
          docker run --rm \
            --volume ${{ github.workspace }}/htmlcov:/app/htmlcov \
            harpotab:latest \
            pytest tests/ --cov=modules --cov-report=html --cov-report=term
        continue-on-error: true

      # -----------------------------------------------------------------------
      # ÉTAPE 9: Upload des artifacts
      # -----------------------------------------------------------------------
      - name: Upload du rapport de couverture
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-coverage-report
          path: htmlcov/
          retention-days: 30

      # -----------------------------------------------------------------------
      # ÉTAPE 10: Rotation du cache Docker
      # -----------------------------------------------------------------------
      # Évite que le cache grandisse indéfiniment
      - name: Rotation du cache Docker
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

# =============================================================================
# NOTES D'UTILISATION
# =============================================================================
#
# 1. LANCEMENT MANUEL:
#    - Aller sur GitHub → Actions → "Docker Integration Tests" → "Run workflow"
#
# 2. LANCEMENT AUTOMATIQUE:
#    - Actuellement: uniquement sur push vers main (commenté)
#    - Pour activer: décommenter la section "push:" dans "on:"
#
# 3. AJOUT DE TESTS D'INTÉGRATION:
#    - Créer tests/integration/test_audiveris_integration.py
#    - Ajouter des fichiers de test dans tests/fixtures/
#    - Modifier l'étape 7 pour lancer ces tests
#
# 4. DURÉE D'EXÉCUTION:
#    - Build Docker: ~5-8 minutes (première fois)
#    - Tests: ~1-2 minutes
#    - Total: ~10 minutes (vs 30s pour tests.yml)
#
# 5. CACHE:
#    - Les layers Docker sont cachés pour accélérer les builds suivants
#    - Si Dockerfile change, le cache est invalidé
#
# 6. QUOTAS GITHUB ACTIONS:
#    - Compte gratuit: 2000 minutes/mois
#    - Ce workflow consomme ~10 minutes par exécution
#    - Recommandation: lancer manuellement ou seulement sur main
#
