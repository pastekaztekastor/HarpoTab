{% extends "base.html" %}

{% block title %}HarpoTab - Convertir{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-arrow-repeat"></i> Convertir une Partition
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="convertForm">
                        <!-- Upload File -->
                        <div class="mb-4">
                            <label for="file" class="form-label fw-bold">
                                <i class="bi bi-file-earmark-arrow-up"></i> Fichier de partition
                            </label>
                            <input
                                type="file"
                                class="form-control"
                                id="file"
                                name="file"
                                accept=".pdf,.png,.jpg,.jpeg"
                                required
                            >
                            <div class="form-text">
                                Formats acceptés : PDF, PNG, JPEG (max 10 MB)
                            </div>
                        </div>

                        <!-- Harmonica Type -->
                        <div class="mb-4">
                            <label for="harmonica_type" class="form-label fw-bold">
                                <i class="bi bi-soundwave"></i> Type d'Harmonica
                            </label>
                            <select class="form-select" id="harmonica_type" name="harmonica_type" required>
                                {% for type_key, type_info in harmonica_types.items() %}
                                    <option value="{{ type_key }}">{{ type_info.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Harmonica Key -->
                        <div class="mb-4">
                            <label for="harmonica_key" class="form-label fw-bold">
                                <i class="bi bi-music-note"></i> Tonalité de l'Harmonica
                            </label>
                            <select class="form-select" id="harmonica_key" name="harmonica_key" required>
                                <!-- Options dynamiques selon le type -->
                            </select>
                            <div class="form-text">
                                Sélectionnez la tonalité de votre harmonica
                            </div>
                        </div>

                        <!-- Advanced Options (collapsed) -->
                        <div class="mb-4">
                            <button
                                class="btn btn-outline-secondary btn-sm"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#advancedOptions"
                            >
                                <i class="bi bi-gear"></i> Options avancées
                            </button>

                            <div class="collapse mt-3" id="advancedOptions">
                                <div class="card card-body bg-light">
                                    <div class="form-check mb-2">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="auto_transpose"
                                            name="auto_transpose"
                                            checked
                                        >
                                        <label class="form-check-label" for="auto_transpose">
                                            Transposition automatique
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="show_chords"
                                            name="show_chords"
                                            checked
                                        >
                                        <label class="form-check-label" for="show_chords">
                                            Afficher les accords
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="prefer_lower_keys"
                                            name="prefer_lower_keys"
                                            checked
                                        >
                                        <label class="form-check-label" for="prefer_lower_keys">
                                            Préférer les tonalités basses
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-arrow-repeat"></i> Convertir
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mt-4">
                <h6><i class="bi bi-info-circle"></i> Conseils pour de meilleurs résultats</h6>
                <ul class="mb-0 small">
                    <li>Utilisez des partitions de bonne qualité (nettes et lisibles)</li>
                    <li>Privilégiez les partitions simples (une seule mélodie)</li>
                    <li>Pour les partitions piano, la mélodie (main droite) sera extraite</li>
                    <li>Le temps de traitement dépend de la complexité de la partition</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mise à jour dynamique des tonalités selon le type d'harmonica
document.addEventListener('DOMContentLoaded', function() {
    const harmonicaTypes = {{ harmonica_types | tojson }};
    const typeSelect = document.getElementById('harmonica_type');
    const keySelect = document.getElementById('harmonica_key');

    function updateKeys() {
        const selectedType = typeSelect.value;
        const keys = harmonicaTypes[selectedType].keys;

        keySelect.innerHTML = '';
        keys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key;
            keySelect.appendChild(option);
        });
    }

    typeSelect.addEventListener('change', updateKeys);
    updateKeys(); // Init
});
</script>
{% endblock %}
